---
title: "EDH Milestones"
author: "Petra Hermankova"
date: "01/07/2020"
output:
  html_document:
    theme: cerulean
    toc: yes
    toc_depth: 3
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r setup, echo=FALSE, message=FALSE}
devtools::install_github("mplex/cedhar", subdir="pkg/sdam")
library(tidyverse)
library(sdam)
library(jsonlite)
library(getPass)
library(formatR)
library(leaflet)
```

### Loading data

## 1. Load the credentials from external csv
```{r}
mycred_secret<- readLines("~/mysecret.txt")
```

## 2. Make the request (you will be asked for password in a new pop-up window)
```{r, echo = FALSE }
resp = request("EDH_attrs_cleaned_2020-09-30.json", path="/sharingin/648597@au.dk/SDAM_root/SDAM_data/EDH/public", method="GET", cred=mycred_secret)
remove(mycred_secret)
```

## 3. Make a list and tibble from the request function
```{r}
list_json <- jsonlite::fromJSON(resp)
EDH_tibble = as_tibble(list_json)
head(EDH_tibble)
```

# What fields might contain milestone related information?
```{r}
EDH_tibble %>% 
  names()
```

# Milestones as type of an inscription

```{r}
unique(EDH_tibble$type_of_inscription_clean)
```
```{r}
milestone_insc <- EDH_tibble %>% 
  filter(type_of_inscription_clean == "mile-/leaguestone")
nrow(milestone_insc)
```

# Milestones as type of monument

```{r}
unique(EDH_tibble$type_of_monument_clean)
```

```{r}
milestone_monument <- EDH_tibble %>% 
  filter(EDH_tibble$type_of_monument_clean == "mile-/leaguestone")

nrow(milestone_monument)
```

# Combine all milestones as type of monument and type of inscription
```{r}
milestone_combined<- EDH_tibble %>% 
  filter(type_of_monument_clean == "mile-/leaguestone" | type_of_inscription_clean == "mile-/leaguestone")
nrow(milestone_combined)
```

# Inspect the commentary for milestone related comments

```{r}
milestone_comment<- EDH_tibble %>%  
  dplyr::filter(str_detect(commentary, "[M|m]eilen"))
nrow(milestone_comment)

head(milestone_comment$commentary)
```

# Combine all milestones that have a word meilen- in commentary and are defined as milestones in type of monument and type of inscription

```{r}
milestone_all <- EDH_tibble %>%  
  dplyr::filter(str_detect(commentary, "[M|m]eilen") | type_of_monument_clean == "mile-/leaguestone" | type_of_inscription_clean == "mile-/leaguestone" ) 
nrow(milestone_all)
```
# How many % of the total number of EDH inscriptions represent milestones
```{r}
nrow(milestone_all)/(nrow(EDH_tibble)/100)
```





# Overview of all milestones

## Type of inscription
```{r}
milestone_all %>% 
  count(milestone_all$type_of_inscription_clean, sort = TRUE)
```
## Type of monument
```{r}
milestone_all %>% 
  count(milestone_all$type_of_monument_clean, sort = TRUE)
```

## Language

```{r}
unnest_auto(milestone_all, language) %>% 
  count(language, sort=TRUE)
```


## Material 
```{r}
milestone_all %>% 
  count(material_clean, sort=TRUE)
```

# Dimensions

```{r}
milestone_dims <- milestone_all %>% 
  dplyr::select(height_cm, width_cm, depth_cm)
milestone_dims <- as.data.frame(milestone_dims)
```

### Basic statistical summary of Height in cm
```{r}
summary(milestone_dims$height_cm)
```

### Basic statistical summary of Width in cm
```{r}
summary(milestone_dims$width_cm)
```

### Basic statistical summary of Depth in cm
```{r}
summary(milestone_dims$depth_cm)
```

# Location

## Ancient findspot - not cleaned
```{r}
head(unique(milestone_all$findspot_ancient))
```

## Ancient findspot - cleaned
```{r}
head(unique(milestone_all$findspot_ancient_clean))
```

## Distribution by Roman provinces

```{r}
milestone_all %>% 
  count(province_label_clean, sort =TRUE)
```

```{r, fig.height=10, fig.width=10}
milestone_all %>% 
  count(province_label_clean, sort =TRUE) %>% 
  ggplot(aes(y=province_label_clean, x=n), size = n) +
  geom_point(color="red") +
  coord_fixed(ratio = 7/1) +
  labs(x = "Number of milestones", y = "Roman province", title = "Number of milestones per Roman Province", subtitle = "n = 1770" ) +
    theme_linedraw(base_size = 12)
```

# Map of milestones (with available coordinates)

```{r}
# selecting milestones with coordinates 
coords_milestone<- as.data.frame(cbind(id = milestone_all$id, 
                                       coordinates = milestone_all$coordinates, 
                                       findspot_ancient_clean = milestone_all$findspot_ancient_clean,
                                       type_of_inscription_clean = milestone_all$type_of_inscription_clean, 
                                       type_of_monument_clean = milestone_all$type_of_monument_clean, 
                                       not_before = milestone_all$not_before,
                                       not_after = milestone_all$not_after,
                                       commentary = milestone_all$commentary))

# milestones with no coordinates
coords_milestone_empty<- coords_milestone %>% 
  dplyr::filter(coordinates == "list()")

# milestones with coordinates
coords_milestone_full<- coords_milestone %>% 
  dplyr::filter(coordinates != "list()")

head(coords_milestone_full)

lat_long_milestone<- coords_milestone_full %>% 
  separate(col = coordinates, into = c("longitude", "latitude"), sep = ",")

lat_long_milestone$latitude <- as.numeric(str_replace(lat_long_milestone$latitude, pattern = "\\)", replacement=""))
lat_long_milestone$longitude <- as.numeric(str_replace(lat_long_milestone$longitude, pattern = "c\\(", replacement=""))


# how many milestones have coordinates
nrow(lat_long_milestone)
```

## Map as dots
```{r}
map_milestones_dot <-leaflet() %>%
  addProviderTiles("Stamen.Watercolor")%>% # Add CartoDB map tiles
  addCircles(lng = lat_long_milestone$longitude, 
             lat = lat_long_milestone$latitude, radius = 10, fill = TRUE, color= , fillColor = lat_long_milestone$type_of_monument_clean,
             popup = paste0("<b> InscriptionID: </b>", lat_long_milestone$id, 
                            "<br><b> Ancient findspot: </b>", lat_long_milestone$findspot_ancient,
                             "<br><b> Type of inscription: </b>", lat_long_milestone$type_of_inscription_clean,
                              "<br><b> Type of monument: </b>", lat_long_milestone$type_of_monument_clean,
                              "<br><b> Not before (date): </b>", lat_long_milestone$not_before,
                              "<br><b> Not after (date): </b>", lat_long_milestone$not_after,
                                "<br><b> Commentary: </b>", lat_long_milestone$commentary),
) %>% 
addLegend(position = "topright",
  colors = c("Blue"),
  labels = c("Milestones (n=1770)"), opacity = 1,
  title = "Position of all milestones in the EDH dataset" 
)
map_milestones_dot

```


# Map as clusters
```{r}
map_milestones_cluster <-leaflet() %>%
  #addProviderTiles("Esri.WorldTopoMap", group = "Topo") %>%
  addProviderTiles("Esri.WorldImagery", group = "ESRI Aerial") %>%
  addMarkers(lng = lat_long_milestone$longitude, 
             lat = lat_long_milestone$latitude,
             popup = paste0("<b> InscriptionID: </b>", lat_long_milestone$id, 
                            "<br><b> Ancient findspot: </b>", lat_long_milestone$findspot_ancient,
                             "<br><b> Type of inscription: </b>", lat_long_milestone$type_of_inscription_clean,
                              "<br><b> Type of monument: </b>", lat_long_milestone$type_of_monument_clean,
                              "<br><b> Not before (date): </b>", lat_long_milestone$not_before,
                                "<br><b> Not after (date): </b>", lat_long_milestone$not_after,
                                "<br><b> Commentary: </b>", lat_long_milestone$commentary),
             
    clusterOptions = markerClusterOptions()
  ) %>% 
addLegend(position = "topright",
  colors = c("Blue", "Green", "Yellow", "Orange"),
  labels = c("Individual inscription", "Small cluster", "Medium cluster", "Large cluster"), opacity = 1,
  title = "Clustering of all milestones in the EDH dataset" 
)
map_milestones_cluster
```

# Map with Roman roads and provinces

```{r}
library(rgdal)
library(raster)
library(sf)
library(sp)
```
source Roads: http://awmc.unc.edu/awmc/map_data/shapefiles/ba_roads/
source Roman provinces (AD 117): http://awmc.unc.edu/awmc/map_data/shapefiles/cultural_data/political_shading/roman_empire_ad_117/shape/

```{r}
setwd("~/Github/epigraphic_roads")
dir.create("../data/ba_roads")
unzip("../data/ba_roads.zip", exdir = "../data/ba_roads/")
dir.create("../data/roman_empire_200_ad_provinces")
unzip("../data/roman_empire_ad_200_provinces.zip", exdir = "../data/roman_empire_200_ad_provinces")
```

```{r}
roads <- st_read("../data/ba_roads/ba_roads.shp")
provinces200 <- st_read("../data/roman_empire_200_ad_provinces/roman_empire_ad_200_provinces.shp")
```

```{r}
orbis <- readLines("https://raw.githubusercontent.com/emeeks/orbis_v2/master/base_routes.geojson") %>% paste(collapse = "\n") %>% 
  fromJSON(simplifyVector = FALSE)
```

```{r}

map_milestones_provinces<- leaflet() %>%
 #addProviderTiles("Esri.WorldTopoMap", group = "Topo") %>%
 #addProviderTiles("Esri.WorldImagery", group = "ESRI Aerial") %>%
 addProviderTiles("Stamen.Watercolor")%>% # Add CartoDB map tiles
 addPolylines(data = provinces200, color = "red", weight = 2, opacity = 0.8) %>% 
  addCircles(lng = lat_long_milestone$longitude, 
             lat = lat_long_milestone$latitude, radius = 10, fill = TRUE, color = "yellow" , fillColor = "red",
             popup = paste0("<b> InscriptionID: </b>", lat_long_milestone$id, 
                            "<br><b> Ancient findspot: </b>", lat_long_milestone$findspot_ancient,
                             "<br><b> Type of inscription: </b>", lat_long_milestone$type_of_inscription_clean,
                              "<br><b> Type of monument: </b>", lat_long_milestone$type_of_monument_clean,
                              "<br><b> Not before (date): </b>", lat_long_milestone$not_before,
                              "<br><b> Not after (date): </b>", lat_long_milestone$not_after,
                                "<br><b> Commentary: </b>", lat_long_milestone$commentary),
) %>% 
addLegend(position = "topright",
  colors = c("Yellow", "Red"),
  labels = c("Milestones", "Roman Province bondaries (200 AD)"), opacity = 1,
  title = "Milestones in the Roman Empire" 
)
map_milestones_provinces
```

```{r}
map_milestones_roads<- leaflet() %>%
 addProviderTiles("Stamen.Watercolor")%>% # Add CartoDB map tiles
 #addProviderTiles("Esri.WorldTopoMap", group = "Topo") %>%
 #addProviderTiles("Esri.WorldImagery", group = "ESRI Aerial") %>%
 addPolylines(data = roads, color = "purple", weight = 1, opacity = 0.7) %>% 
  addCircles(lng = lat_long_milestone$longitude, 
             lat = lat_long_milestone$latitude, opacity = 0.7, radius = 10, fill = TRUE, color = "yellow" , fillColor = "red",
             popup = paste0("<b> InscriptionID: </b>", lat_long_milestone$id, 
                            "<br><b> Ancient findspot: </b>", lat_long_milestone$findspot_ancient,
                             "<br><b> Type of inscription: </b>", lat_long_milestone$type_of_inscription_clean,
                              "<br><b> Type of monument: </b>", lat_long_milestone$type_of_monument_clean,
                              "<br><b> Not before (date): </b>", lat_long_milestone$not_before,
                              "<br><b> Not after (date): </b>", lat_long_milestone$not_after,
                                "<br><b> Commentary: </b>", lat_long_milestone$commentary),
             ) %>% 
addLegend(position = "topright",
  colors = c("Yellow", "Purple"),
  labels = c("Milestones", "Roman roads (BA atlas)"), opacity = 1,
  title = "Milestones and Roman roads" 
)
map_milestones_roads
```

# Location of milestones compared with all inscriptions

```{r}
# inscriptions with coordinates

lat_long_EDH <- EDH_tibble %>%  
  separate(col = coordinates, into = c("longitude", "latitude"), sep = ",")
lat_long_EDH

lat_long_EDH$latitude <- as.numeric(str_replace(lat_long_EDH$latitude, pattern = "\\)", replacement=""))
lat_long_EDH$longitude <- as.numeric(str_replace(lat_long_EDH$longitude, pattern = "c\\(", replacement=""))

# how many inscriptions have coordinates
nrow(lat_long_EDH)

# how many % of the total represent milestones with coordinates
nrow(lat_long_milestone)/(nrow(lat_long_EDH)/100)
```

```{r}
map_milestones_compared<- leaflet() %>%
# addProviderTiles("Stamen.TerrainBackground")%>% # Add CartoDB map tiles
 addProviderTiles("Stamen.Watercolor")%>% # Add CartoDB map tiles
# addProviderTiles("Esri.WorldImagery", group = "ESRI Aerial") %>%
# addPolylines(data = roads, color = "purple", weight = 2, opacity = 0.7) %>% 
  setView( lng = 22.326743, lat = 46.897122, zoom = 4 ) %>%
  setMaxBounds(lat1=43.633977, lng1 =-11.227926 , lat2=35.133882 , lng2=50.882336) %>% 
  addCircles(lng = lat_long_EDH$longitude, 
             lat = lat_long_EDH$latitude, opacity = 0.5, radius = 10, fill = TRUE, color = "black" , fillColor = "white",) %>% 
  addCircles(lng = lat_long_milestone$longitude, 
             lat = lat_long_milestone$latitude, opacity = 0.5, radius = 10, fill = TRUE, color = "yellow" , fillColor = "",
             popup = paste0("<b> InscriptionID: </b>", lat_long_milestone$id, 
                            "<br><b> Ancient findspot: </b>", lat_long_milestone$findspot_ancient,
                             "<br><b> Type of inscription: </b>", lat_long_milestone$type_of_inscription_clean,
                              "<br><b> Type of monument: </b>", lat_long_milestone$type_of_monument_clean,
                              "<br><b> Not before (date): </b>", lat_long_milestone$not_before,
                              "<br><b> Not after (date): </b>", lat_long_milestone$not_after,
                                "<br><b> Commentary: </b>", lat_long_milestone$commentary),
             ) %>% 
addLegend(position = "topright",
  colors = c("Yellow", "Black"),
  labels = c("Milestones", "Other inscriptions"), opacity = 1,
  title = "Milestones vs other inscriptions (EDH)"
)
map_milestones_compared
```


## Dates
```{r}
#dates<- milestone_all %>% 
  #select(not_before, not_after, origdate_text, origdate_attrs) 
#dates_flat <- flatten(dates)
#dates_flat$not_before <- as.numeric(dates_flat$not_before)
#dates_flat$not_after <- as.numeric(dates_flat$not_after)
#summary(dates_flat$not_before)
```

```{r}
#plot(dates_flat$not_before)
```

```{r}
#summary(dates_flat$not_after)
```
```{r}
#plot(dates_flat$not_after)
```

## Temporal distribution of 'not_before' years of milestones
```{r}
#plot(table(dates_flat$not_before), ylab= "Number of inscriptions", xlab="'Not before' YEAR")
```

### Combining dates and provinces - unfinished

```{r,chunk-label, results='hide', fig.height=4}
#milestones_flat <- flatten(milestone_all)
#milestones_flat
```

```{r}
# remove any traces of the secret password from the document
remove(mycred_secret)
```

